package main

import (
	"flag"
	"os"

	"github.com/zomasec/CVE-2024-4577/pkg/runner"
	"github.com/zomasec/CVE-2024-4577/config"
	"github.com/zomasec/CVE-2024-4577/pkg/utils"
)

var cfg = config.Init()

func main() {

	// Print banner
	config.PrintBanner()

	// Define flags
	hostsFile := flag.String("l", "", "File containing list of hosts to scan")
	host := flag.String("d", "", "Single host to scan")
	concurrency := flag.Int("c", 10, "Number of concurrent scans")
	timeout := flag.Int("timeout", 5, "Request timeout in seconds")

	flag.Parse()

	opts := &runner.Options{}

	opts.Concurrency = *concurrency
	opts.Timeout = *timeout
	
	if *hostsFile == "" && *host == "" {
		cfg.Logger.FATAL("Please provide a list of hosts or a single host to scan")
		os.Exit(1)
	
	}

	if *hostsFile != "" {
		if _, err := os.Stat(*hostsFile); os.IsNotExist(err) {
			cfg.Logger.FATAL("Hosts file does not exist")
			os.Exit(1)
		} else {
			opts.Hosts, err = utils.ReadHostsFromFile(*hostsFile)
			if err != nil {
				cfg.Logger.FATAL("Error reading hosts file: %v", err)
				os.Exit(1)
			}
		}
	
	}

	if *host != "" && *hostsFile == "" {
		opts.Hosts = append(opts.Hosts, *host)
	}

	runner.New(opts).Run()

}
